<!DOCTYPE html>
<html>
<head>
    <title>ìš°ë¦¬ ì•„ê¸° ì„±ì¥ì¼ì§€</title>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
    
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="text/javascript" src="cordova.js"></script>
    
    <style>
    .ui-header {
        background-color: #e0b071 !important;
        border-color: #66513569 !important;
        color: rgba(255, 255, 255, 0.863) !important;
        text-shadow: 0 1px 0 #2980b9 !important;
    }

    #growthChartContainer { 
        width: 100%; 
        max-width: 600px; 
        margin: 15px auto; 
    }

    #album-list img { 
        width: 80px; 
        height: 80px; 
        object-fit: cover; 
        margin-right: 10px; 
    }

    .btn-fab { 
        position: fixed !important; 
        right: 20px; 
        bottom: 70px; 
        z-index: 100; 
        padding: 0.8em !important; 
        border-radius: 50% !important; 
    }

    .btn-fab.ui-btn-icon-notext::after { 
        width: 24px !important; 
        height: 24px !important; 
        font-size: 24px !important; 
        margin-left: -12px !important; 
        margin-top: -12px !important; 
    }

    #album-detail-content img { 
        width: 100%; 
        max-width: 500px; 
        height: auto; 
        border: 1px solid #ddd; 
    }

    .detail-memo { 
        white-space: pre-wrap; 
        background-color: #f9f9f9; 
        padding: 15px; 
        border-radius: 5px; 
        margin-top: 10px; 
    }

    .delete-growth-item { 
        color: rgba(228, 36, 36, 0.808) !important; 
        text-decoration: none !important; 
    }

    #album-delete-btn, 
    #schedule-delete-btn { 
        margin-left: 20px !important; 
        margin-right: 20px !important; 
    }

    #random-photo-container { 
        margin-top: 20px; 
        text-align: center; 
    }

    #random-photo-container img { 
        width: 100%; 
        max-width: 400px; 
        height: auto; 
        max-height: 400px; 
        object-fit: cover; 
        border-radius: 8px;
        border: 1px solid #ddd; 
    }

    #random-photo-container p { 
        font-style: italic; 
        color: #555; 
        margin-top: 5px; 
    }

    a.random-photo-link { 
        text-decoration: none; 
        color: inherit; 
    }

    .ui-navbar {
        background-color: #e0b071 !important;
        border-top-color: #66513569 !important;
    }

    .ui-navbar li a.ui-btn {
        background-color: #e0b071 !important;
        color: #222222 !important;
        text-shadow: 0 1px 0 white !important;
    }

    .ui-navbar li a.ui-btn.ui-btn-active {
        background-color: #66513569 !important;
        color: rgba(255, 255, 255, 0.863) !important;
        text-shadow: 0 1px 0 #362c1d69 !important;
    }


    /* ===========================================================
       ğŸ”¥ ë°˜ì‘í˜• Safe-area + ë„ë„í•œ UI ì—¬ë°± + ìë™ ì½˜í…ì¸  ìœ„ì¹˜ ì¡°ì •
       =========================================================== */

    /* í—¤ë”ë¥¼ ì‹œìŠ¤í…œ ìƒë‹¨ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ë¶„ë¦¬ */
    .ui-header[data-position="fixed"] {
        padding-top: max(env(safe-area-inset-top), 1.5vh);
    }

    /* í‘¸í„°ë¥¼ ì‹œìŠ¤í…œ í•˜ë‹¨ê³¼ ìì—°ìŠ¤ëŸ½ê²Œ ë” ìœ„ë¡œ ë„ì›€ */
    .ui-footer[data-position="fixed"] {
        padding-bottom: max(env(safe-area-inset-bottom), 4.5vh);
    }

    /* ì½˜í…ì¸ ê°€ í‘¸í„°ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì—¬ë°± í™•ë³´ */
    .ui-page .ui-content {
        padding-bottom: calc(max(env(safe-area-inset-bottom), 4.5vh) + var(--footer-height, 46px));
    }


    /* í—¤ë”Â·í‘¸í„° ê¸°ë³¸ ë†’ì´ (ë°˜ì‘í˜• ê¸°ì¤€ê°’) */
    .ui-header {
        --header-height: 38px;
    }

    .ui-footer {
        --footer-height: 46px;
    }


</style>

</head>
<body>

<div data-role="page" id="home">
    <div data-role="header" data-position="fixed">
        <h1>ìš°ë¦¬ ì•„ê¸° ì„±ì¥ì¼ì§€</h1>
    </div>
    <div data-role="content">
        <h3 id="welcome-message">ì•„ê¸° ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!</h3>
        <p>ì†Œì¤‘í•œ ìˆœê°„ì„ ê¸°ë¡í•´ë³´ì„¸ìš”.</p>
        <div data-role="collapsible" data-collapsed="false">
            <h3>ë¹ ë¥¸ ê¸°ë¡</h3>
            <div class="ui-grid-b">
                <div class="ui-block-a"><a href="#addPhoto" data-role="button" data-icon="camera" data-transition="slideup">ì‚¬ì§„/ì˜ìƒ</a></div>
                <div class="ui-block-b"><a href="#data" data-role="button" data-icon="edit" data-transition="fade">í‚¤/ëª¸ë¬´ê²Œ</a></div>
                <div class="ui-block-c"><a href="#schedule" data-role="button" data-icon="calendar" data-transition="fade">ì¼ì •</a></div>
            </div>
        </div>
        
        <div class="ui-body-a ui-corner-all" style="padding: 10px; margin-top: 15px;">
            <h3>ì˜¤ëŠ˜ì˜ ì¶”ì–µ</h3>
            <div id="random-photo-container">
                <p>ì•„ì§ ì €ì¥ëœ ì‚¬ì§„ì´ ì—†ì–´ìš”.</p>
            </div>
        </div>
        
        <a href="#addPhoto" data-role="button" data-icon="camera" data-iconpos="notext" data-transition="slideup" class="btn-fab ui-btn-b">ì‚¬ì§„ ì¶”ê°€</a>
    </div>
    <div data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#home" data-icon="home" class="ui-btn-active ui-state-persist">í™ˆ</a></li>
                <li><a href="#album" data-icon="photo">ì„±ì¥ ì•¨ë²”</a></li>
                <li><a href="#data" data-icon="bars">ì„±ì¥ ë°ì´í„°</a></li>
                <li><a href="#schedule" data-icon="calendar">ì¼ì •</a></li>
                <li><a href="#settings" data-icon="gear">ì„¤ì •</a></li>
            </ul>
        </div>
    </div>
</div>

<div data-role="page" id="addPhoto">
    <div data-role="header">
        <h1>ìƒˆë¡œìš´ ê¸°ë¡</h1>
        <a href="#" data-rel="back" data-icon="delete" data-iconpos="notext" class="ui-btn-right">ë‹«ê¸°</a>
    </div>
    <div data-role="content">
        <form id="photo-form">
            
            <button type="button" onclick="takePicture()" data-icon="camera" data-theme="b">ì‚¬ì§„ ì°ê¸°</button>
            <button type="button" onclick="selectFromGallery()" data-icon="grid" data-theme="a" style="margin-bottom: 20px;">ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</button>

            <img id="preview" src="" alt="ë¯¸ë¦¬ë³´ê¸°" style="width:100%; max-width: 300px; display:none; margin-top:10px; border: 1px solid #ddd;">
            
            <div id="memo-fields" style="display:none;">
                <label for="record-type">ì‚¬ì§„ ì¢…ë¥˜:</label>
                <select name="record-type" id="record-type">
                    <option value="default">ì¼ë°˜</option>
                    <option value="smile">ì›ƒìŒ</option>
                    <option value="sleep">ìˆ˜ë©´</option>
                    <option value="eat">ì‹ì‚¬</option>
                    <option value="play">ë†€ì´</option>
                </select>
                <label for="record-memo">ë©”ëª¨:</label>
                <textarea name="record-memo" id="record-memo"></textarea>
            </div>
            
            <button type="submit" id="save-photo-btn" data-icon="check" style="display:none;">ì €ì¥í•˜ê¸°</button>
        </form>
    </div>
</div>

<div data-role="page" id="album">
    <div data-role="header" data-position="fixed">
        <h1>ì„±ì¥ ì•¨ë²”</h1>
        </div>
    <div data-role="content">
        <ul data-role="listview" id="album-list" data-inset="true">
           </ul>
        
        <a href="#addPhoto" data-role="button" data-icon="camera" data-iconpos="notext" data-transition="slideup" class="btn-fab ui-btn-b">ì‚¬ì§„ ì¶”ê°€</a>
    </div>
    <div data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#home" data-icon="home">í™ˆ</a></li>
                <li><a href="#album" data-icon="photo" class="ui-btn-active ui-state-persist">ì„±ì¥ ì•¨ë²”</a></li>
                <li><a href="#data" data-icon="bars">ì„±ì¥ ë°ì´í„°</a></li>
                <li><a href="#schedule" data-icon="calendar">ì¼ì •</a></li>
                <li><a href="#settings" data-icon="gear">ì„¤ì •</a></li>
            </ul>
        </div>
    </div>
</div>

<div data-role="page" id="data">
    <div data-role="header" data-position="fixed">
        <h1>ì„±ì¥ ë°ì´í„°</h1>
    </div>
    <div data-role="content">
        <div data-role="collapsible" data-collapsed="false">
            <h3>ë°ì´í„° ì…ë ¥</h3>
            <form id="growth-form">
                <label for="growth-date">ì¸¡ì •ì¼:</label>
                <input type="date" id="growth-date" name="growth-date" value="">
                <label for="growth-height">í‚¤ (cm):</label>
                <input type="number" step="0.1" id="growth-height" name="growth-height" placeholder="ì˜ˆ: 65.5">
                <label for="growth-weight">ëª¸ë¬´ê²Œ (kg):</label>
                <input type="number" step="0.01" id="growth-weight" name="growth-weight" placeholder="ì˜ˆ: 7.2">
                <button type="submit" id="save-growth-btn" data-icon="check">ì €ì¥</button>
            </form>
        </div>
        <hr>
        <h3>ì„±ì¥ ê·¸ë˜í”„</h3>
        <p>ì…ë ¥ëœ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„±ì¥ ê³¡ì„ ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        <div id="growthChartContainer">
            <canvas id="growthChart"></canvas>
        </div>
        
        <h3>ì…ë ¥ ê¸°ë¡</h3>
        <ul data-role="listview" id="growth-history-list" data-inset="true">
           </ul>
    </div>
    <div data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#home" data-icon="home">í™ˆ</a></li>
                <li><a href="#album" data-icon="photo">ì„±ì¥ ì•¨ë²”</a></li>
                <li><a href="#data" data-icon="bars" class="ui-btn-active ui-state-persist">ì„±ì¥ ë°ì´í„°</a></li>
                <li><a href="#schedule" data-icon="calendar">ì¼ì •</a></li>
                <li><a href="#settings" data-icon="gear">ì„¤ì •</a></li>
            </ul>
        </div>
    </div>
</div>

<div data-role="page" id="schedule">
    <div data-role="header" data-position="fixed">
        <h1>ì¼ì • ë° ì•Œë¦¼</h1>
    </div>
    <div data-role="content">
        <p>ì˜ˆë°©ì ‘ì¢…, ë³‘ì› ë°©ë¬¸ ë“± ì¤‘ìš” ì¼ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
        <ul data-role="listview" id="schedule-list" data-inset="true">
        </ul>
        <a href="#addSchedulePopup" data-rel="popup" data-position-to="window" data-transition="pop" data-role="button" data-icon="plus" data-iconpos="notext" class="btn-fab ui-btn-b">ì¼ì • ì¶”ê°€</a>
    </div>
    <div data-role="popup" id="addSchedulePopup" data-overlay-theme="b" data-theme="a" style="max-width:400px;">
        <div data-role="header">
            <h1>ìƒˆ ì¼ì • ì¶”ê°€</h1>
        </div>
        <div role="main" class="ui-content">
            <form id="schedule-form">
                <label for="schedule-title">ì¼ì • ì œëª©:</label>
                <input type="text" id="schedule-title" name="schedule-title" placeholder="ì˜ˆ: Bí˜• ê°„ì—¼ 2ì°¨">
                <label for="schedule-date">ë‚ ì§œ ë° ì‹œê°„:</label>
                <input type="datetime-local" id="schedule-date" name="schedule-date">
                <label for="schedule-alert">ì•Œë¦¼ ì„¤ì •:</label>
                <select name="schedule-alert" id="schedule-alert" data-role="slider">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
                <button type="submit" id="save-schedule-btn" data-icon="check">ì¼ì • ì €ì¥</button>
            </form>
        </div>
    </div>
    <div data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#home" data-icon="home">í™ˆ</a></li>
                <li><a href="#album" data-icon="photo">ì„±ì¥ ì•¨ë²”</a></li>
                <li><a href="#data" data-icon="bars">ì„±ì¥ ë°ì´í„°</a></li>
                <li><a href="#schedule" data-icon="calendar" class="ui-btn-active ui-state-persist">ì¼ì •</a></li>
                <li><a href="#settings" data-icon="gear">ì„¤ì •</a></li>
            </ul>
        </div>
    </div>
</div>

<div data-role="page" id="settings">
    <div data-role="header" data-position="fixed">
        <h1>âš™ï¸ ì•„ê¸° ì •ë³´</h1>
    </div>
    <div data-role="content">
        <form id="settings-form">
            <label for="baby-name">ì•„ê¸° ì´ë¦„:</label>
            <input type="text" id="baby-name" name="baby-name">
            <label for="baby-birthday">ìƒì¼:</label>
            <input type="date" id="baby-birthday" name="baby-birthday">
            <fieldset data-role="controlgroup" data-type="horizontal">
                <legend>ì„±ë³„:</legend>
                <input type="radio" name="baby-gender" id="gender-male" value="male" checked="checked">
                <label for="gender-male">ë‚¨ì</label>
                <input type="radio" name="baby-gender" id="gender-female" value="female">
                <label for="gender-female">ì—¬ì</label>
            </fieldset>
            <button type="submit" id="save-settings-btn" data-icon="check">ì •ë³´ ì €ì¥</button>
        </form>
    </div>
    <div data-role="footer" data-position="fixed">
        <div data-role="navbar">
            <ul>
                <li><a href="#home" data-icon="home">í™ˆ</a></li>
                <li><a href="#album" data-icon="photo">ì„±ì¥ ì•¨ë²”</a></li>
                <li><a href="#data" data-icon="bars">ì„±ì¥ ë°ì´í„°</a></li>
                <li><a href="#schedule" data-icon="calendar">ì¼ì •</a></li>
                <li><a href="#settings" data-icon="gear" class="ui-btn-active ui-state-persist">ì„¤ì •</a></li>
            </ul>
        </div>
    </div>
</div>

<div data-role="page" id="album-detail">
    <div data-role="header" data-position="fixed">
        <a href="#" data-rel="back" data-icon="back" data-iconpos="notext">ë’¤ë¡œ</a>
        <h1>ìƒì„¸ ë³´ê¸°</h1>
    </div>
    <div data-role="content" id="album-detail-content">
    </div>
    <div data-role="footer" data-position="fixed">
        <a href="#" id="album-delete-btn" data-role="button" data-icon="delete" data-theme="b">ì‚­ì œí•˜ê¸°</a>
    </div>
</div>

<div data-role="page" id="schedule-detail">
    <div data-role="header" data-position="fixed">
        <a href="#" data-rel="back" data-icon="back" data-iconpos="notext">ë’¤ë¡œ</a>
        <h1>ì¼ì • ìƒì„¸</h1>
    </div>
    <div data-role="content" id="schedule-detail-content">
    </div>
    <div data-role="footer" data-position="fixed">
        <a href="#" id="schedule-delete-btn" data-role="button" data-icon="delete" data-theme="b">ì¼ì • ì‚­ì œ</a>
    </div>
</div>


<script>
// ì „ì—­ ë³€ìˆ˜
var myGrowthChart;
var capturedImageURI = null;
const isCordovaApp = (typeof window.cordova !== 'undefined');
var isDeviceReady = false; 

if (isCordovaApp) {
    document.addEventListener('deviceready', function() {
        isDeviceReady = true;
        console.log("âœ… Cordova Device Ready!");
        
        // ğŸŒŸ [ìˆ˜ì •ë¨] 
        // StatusBar.overlaysWebView(false) ì½”ë“œë¥¼ ì œê±°í•˜ì—¬ safe-area CSSê°€ ì‘ë™í•˜ë„ë¡ í•©ë‹ˆë‹¤.
        // trueê°€ ê¸°ë³¸ê°’ì´ë¯€ë¡œ ê²¹ì¹˜ëŠ” ê²ƒì´ ì •ìƒì´ë©°, CSSê°€ íŒ¨ë”©/ë§ˆì§„ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        if (window.StatusBar) {
            StatusBar.backgroundColorByHexString("#e0b071"); // í—¤ë” ìƒ‰ìƒê³¼ ë§ì¶¤
        }
    }, false);
} else {
    isDeviceReady = true; 
}

function convertFileSrc(fileURI) {
    if (!fileURI) return '';
    if (window.Ionic && window.Ionic.WebView && window.Ionic.WebView.convertFileSrc) {
        return window.Ionic.WebView.convertFileSrc(fileURI);
    }
    return fileURI;
}

function copyToDataDirectory(fileURI, callback) {
    if (!window.cordova || !window.resolveLocalFileSystemURL) {
        console.warn("âš ï¸ cordova-plugin-fileì´ í•„ìš”í•©ë‹ˆë‹¤. ì›ë³¸ URIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
        callback(fileURI);
        return;
    }
    window.resolveLocalFileSystemURL(fileURI, function(fileEntry) {
        const timestamp = new Date().getTime();
        const extension = fileEntry.name.split('.').pop() || 'jpg';
        const newFileName = `baby_photo_${timestamp}.${extension}`;
        const dataDir = window.cordova.file.dataDirectory;
        window.resolveLocalFileSystemURL(dataDir, function(dirEntry) {
            fileEntry.copyTo(
                dirEntry, 
                newFileName, 
                function(newFileEntry) {
                    console.log("âœ… íŒŒì¼ ì˜êµ¬ ì €ì¥ ì™„ë£Œ:", newFileEntry.nativeURL);
                    callback(newFileEntry.nativeURL);
                },
                function(error) {
                    console.error("âŒ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨:", error);
                    alert("íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    callback(fileURI);
                }
            );
        }, function(error) {
            console.error("âŒ ë””ë ‰í† ë¦¬ ì ‘ê·¼ ì‹¤íŒ¨:", error);
            callback(fileURI);
        });
    }, function(error) {
        console.error("âŒ íŒŒì¼ ì ‘ê·¼ ì‹¤íŒ¨:", error);
        callback(fileURI);
    });
}

// BabyApi (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ ë¡œì§ - ë³€ê²½ ì—†ìŒ)
const BabyApi = {
    get: function(key, defaultValue) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
    },
    set: function(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    },
    saveBabyInfo: function(info) {
        this.set('babyInfo', info);
    },
    getBabyInfo: function() {
        return this.get('babyInfo', { name: '', birthday: '', gender: 'male' });
    },
    saveAlbumRecord: function(record) {
        const records = this.get('albumRecords', []);
        records.push(record);
        records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        this.set('albumRecords', records);
    },
    getAlbumRecords: function() {
        return this.get('albumRecords', []);
    },
    deleteAlbumRecord: function(index) {
        const records = this.get('albumRecords', []);
        if (index > -1 && index < records.length) {
            records.splice(index, 1);
            this.set('albumRecords', records);
        }
    },
    saveGrowthData: function(data) {
        const growthData = this.get('growthData', []);
        growthData.push(data);
        growthData.sort((a, b) => new Date(a.date) - new Date(b.date));
        this.set('growthData', growthData);
    },
    getGrowthData: function() {
        return this.get('growthData', []);
    },
    deleteGrowthData: function(index) {
        const growthData = this.get('growthData', []);
        if (index > -1 && index < records.length) {
            growthData.splice(index, 1); 
            this.set('growthData', growthData);
        }
    },
    saveSchedule: function(schedule) {
        const schedules = this.get('schedules', []);
        schedules.push(schedule);
        schedules.sort((a, b) => new Date(a.date) - new Date(b.date));
        this.set('schedules', schedules);
    },
    getSchedules: function() {
        return this.get('schedules', []);
    },
    deleteSchedule: function(index) {
        const schedules = this.get('schedules', []);
        if (index > -1 && index < records.length) {
            schedules.splice(index, 1);
            this.set('schedules', schedules);
        }
    }
};

/**
 * ğŸŒŸ [ìœ ì§€] "ì‚¬ì§„ ì°ê¸°" ì „ìš© í•¨ìˆ˜
 * (ìˆ˜ë™ ê¶Œí•œ ìš”ì²­ ë¡œì§ ì œê±°ë¨)
 */
function takePicture() {
    $("#preview").attr("src", "").hide(); 
    $('#memo-fields, #save-photo-btn').hide();

    if (!isCordovaApp || !isDeviceReady) {
        alert("âš ï¸ ì•± ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return;
    }
    if (typeof navigator.camera === 'undefined') {
        alert("âš ï¸ cordova-plugin-cameraê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }
    
    runNativePhotoTool(Camera.PictureSourceType.CAMERA);
}

/**
 * ğŸŒŸ [ìœ ì§€] "ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ" ì „ìš© í•¨ìˆ˜
 * (ìˆ˜ë™ ê¶Œí•œ ìš”ì²­ ë¡œì§ ì œê±°ë¨)
 */
function selectFromGallery() {
    $("#preview").attr("src", "").hide(); 
    $('#memo-fields, #save-photo-btn').hide();

    if (!isCordovaApp || !isDeviceReady) {
        alert("âš ï¸ ì•± ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return;
    }
    if (typeof navigator.camera === 'undefined') {
        alert("âš ï¸ cordova-plugin-cameraê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }

    runNativePhotoTool(Camera.PictureSourceType.PHOTOLIBRARY);
}

/**
 * ë„¤ì´í‹°ë¸Œ ì¹´ë©”ë¼/ê°¤ëŸ¬ë¦¬ í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ (ê³µìœ  í•¨ìˆ˜, ë³€ê²½ ì—†ìŒ)
 */
function runNativePhotoTool(sourceType) {
    navigator.camera.getPicture(onSuccess, onFail, {
        quality: 70,
        destinationType: Camera.DestinationType.FILE_URI,
        sourceType: sourceType, 
        encodingType: Camera.EncodingType.JPEG,
        mediaType: Camera.MediaType.PICTURE,
        cameraDirection: Camera.Direction.BACK,          
        saveToPhotoAlbum: true, 
        correctOrientation: true,
        targetWidth: 1024,
        targetHeight: 1024
    });
}

function onSuccess(imageURI) { 
    console.log("ğŸ“¸ ì›ë³¸ ì´ë¯¸ì§€ URI:", imageURI);
    
    copyToDataDirectory(imageURI, function(permanentURI) {
        capturedImageURI = permanentURI;
        console.log("ğŸ’¾ ì˜êµ¬ ì €ì¥ URI:", permanentURI);
        
        const displaySrc = convertFileSrc(permanentURI); 
        $("#preview").attr("src", displaySrc).show();
        
        $('#memo-fields, #save-photo-btn').show();
        $('#record-type').selectmenu('refresh');
    });
}

function onFail(message) {
    console.error("âŒ ì‚¬ì§„ ì ‘ê·¼ ì˜¤ë¥˜:", message);
    if (!message.includes("cancelled") && !message.includes("Camera cancelled")) {
         alert("ì‚¬ì§„ ì ‘ê·¼ ì˜¤ë¥˜: " + message);
    }
}


// jQuery Mobile í˜ì´ì§€ ë¡œë“œ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë³€ê²½ ì—†ìŒ)
$(document).on("pagecreate", function() {
    const today = new Date().toISOString().split('T')[0];
    $('#growth-date').val(today);
    
    $("#settings-form").off("submit").on("submit", function(e) {
        e.preventDefault();
        const info = {
            name: $("#baby-name").val(), 
            birthday: $("#baby-birthday").val(),
            gender: $("input[name='baby-gender']:checked").val()
        };
        BabyApi.saveBabyInfo(info);
        alert("ì•„ê¸° ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        updateWelcomeMessage();
    });
    
    $("#photo-form").off("submit").on("submit", function(e) {
        e.preventDefault();
        if (!capturedImageURI) { 
            alert("ì‚¬ì§„ì„ ë¨¼ì € ì°ê±°ë‚˜ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”."); 
            return; 
        } 

        const record = {
            type: $("#record-type").val(), 
            memo: $("#record-memo").val(),
            timestamp: new Date().toISOString(), 
            imageSrc: capturedImageURI
        };
        
        BabyApi.saveAlbumRecord(record);
        alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        
        capturedImageURI = null;
        $("#photo-form")[0].reset();
        $("#preview").attr("src", "").hide(); 
        $('#memo-fields, #save-photo-btn').hide();
        $(":mobile-pagecontainer").pagecontainer("back");
    });
    
    $("#growth-form").off("submit").on("submit", function(e) {
        e.preventDefault();
        const data = {
            date: $("#growth-date").val(),
            height: $("#growth-height").val(),
            weight: $("#growth-weight").val()
        };
        if (!data.date || (!data.height && !data.weight)) { 
            alert("ë‚ ì§œì™€ í‚¤ ë˜ëŠ” ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
            return; 
        }
        BabyApi.saveGrowthData(data);
        alert("ì„±ì¥ ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        $("#growth-form")[0].reset();
        $('#growth-date').val(today);
        loadGrowthData(); 
    });
    
    $("#schedule-form").off("submit").on("submit", function(e) {
        e.preventDefault();
        const schedule = {
            title: $("#schedule-title").val(),
            date: $("#schedule-date").val(),
            alert: $("#schedule-alert").val()
        };
        if (!schedule.title || !schedule.date) { 
            alert("ì¼ì • ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
            return; 
        }
        BabyApi.saveSchedule(schedule);
        alert("ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
        $("#schedule-form")[0].reset();
        $("#addSchedulePopup").popup("close");
        loadSchedules();
        $('#schedule-alert').val('off').slider('refresh');
        if (schedule.alert === 'on') { 
            requestNotificationPermission(schedule); 
        }
    });

    $(document).on("click", "#album-list a, #schedule-list a, a.random-photo-link", function(e) {
        e.preventDefault(); 
        const $link = $(this);
        const index = $link.data("index"); 
        const pageId = $link.data("page"); 
        $.data(document.body, "selectedIndex", index);
        $(":mobile-pagecontainer").pagecontainer("change", "#" + pageId, {
            transition: "slide"
        });
    });
    
    $("#album-delete-btn").on("click", function(e) {
        e.preventDefault();
        const index = $(this).data("index");
        if (confirm("ì´ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            BabyApi.deleteAlbumRecord(index);
            alert("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            $(":mobile-pagecontainer").pagecontainer("back");
        }
    });
    
    $("#schedule-delete-btn").on("click", function(e) {
        e.preventDefault();
        const index = $(this).data("index");
        if (confirm("ì´ ì¼ì •ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            BabyApi.deleteSchedule(index);
            alert("ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            $(":mobile-pagecontainer").pagecontainer("back");
        }
    });
    
    $(document).on("click", ".delete-growth-item", function(e) {
        e.preventDefault();
        e.stopPropagation(); 
        const index = $(this).data("index");
        if (confirm("ì´ ì„±ì¥ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            BabyApi.deleteGrowthData(index);
            loadGrowthData(); 
        }
    });
});


$(document).on("pagecontainershow", function(event, ui) {
    const pageId = ui.toPage.attr("id");
    switch (pageId) {
        case "home": 
            updateWelcomeMessage(); 
            loadRandomPhoto(); 
            break;
        case "album": 
            loadAlbumRecords(); 
            break;
        case "data": 
            loadGrowthData(); 
            break;
        case "schedule": 
            loadSchedules(); 
            break;
        case "settings": 
            loadBabyInfo(); 
            break;
        case "addPhoto": 
            capturedImageURI = null;
            $("#preview").attr("src", "").hide(); 
            $('#memo-fields, #save-photo-btn').hide();
            break;
        case "album-detail": 
            loadAlbumDetail(); 
            break;
        case "schedule-detail": 
            loadScheduleDetail(); 
            break;
    }
});


// ë‚˜ë¨¸ì§€ ë°ì´í„° ë¡œë“œ ë° ìƒì„¸ í˜ì´ì§€ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
function updateWelcomeMessage() {
    const info = BabyApi.getBabyInfo();
    if (info.name && info.birthday) {
        const birthDate = new Date(info.birthday);
        const today = new Date();
        const diffTime = Math.abs(today - birthDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        $("#welcome-message").html(`ê·€ì—¬ìš´ <strong>${info.name}</strong>`);
    } else {
        $("#welcome-message").text("ì•„ê¸° ì •ë³´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!");
    }
}

function loadBabyInfo() {
    const info = BabyApi.getBabyInfo();
    $("#baby-name").val(info.name);
    $("#baby-birthday").val(info.birthday);
    $(`input[name='baby-gender'][value='${info.gender}']`).prop("checked", true).checkboxradio("refresh");
}

function loadAlbumRecords() {
    const records = BabyApi.getAlbumRecords();
    const $list = $("#album-list");
    $list.empty();
    
    if (records.length === 0) {
        $list.append("<li>ì €ì¥ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>");
    } else {
        records.forEach((record, index) => {
            const date = new Date(record.timestamp);
            const localDate = date.toLocaleDateString();
            const localTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const displaySrc = convertFileSrc(record.imageSrc);

            $list.append(`
                <li>
                    <a href="#" data-index="${index}" data-page="album-detail">
                        <img src="${displaySrc}" alt="${record.type}">
                        <h2>${localDate}</h2>
                        <p><strong>[${record.type}]</strong> ${record.memo || ''}</p>
                        <p class="ui-li-aside">${localTime}</p>
                    </a>
                </li>
            `);
        });
    }
    $list.listview("refresh");
}

function loadGrowthData() {
    const data = BabyApi.getGrowthData();
    const $list = $("#growth-history-list");
    $list.empty();
    
    if (data.length === 0) {
        $list.append("<li>ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>");
    } else {
        [...data].reverse().forEach((item, i) => {
            const originalIndex = (data.length - 1) - i;
            $list.append(`
                <li>
                    <strong>${item.date}</strong>: 
                    ${item.height ? item.height + 'cm' : ''} 
                    ${item.weight ? '/ ' + item.weight + 'kg' : ''}
                    <a href="#" class="delete-growth-item ui-btn-right" data-index="${originalIndex}" data-role="button" data-icon="delete" data-iconpos="notext">X</a>
                </li>
            `);
        });
    }
    $list.listview("refresh");
    
    const labels = data.map(item => item.date);
    const heightData = data.map(item => item.height || null); 
    const weightData = data.map(item => item.weight || null);
    
    const ctx = document.getElementById('growthChart').getContext('2d');
    if (myGrowthChart) {
        myGrowthChart.destroy();
    }
    
    myGrowthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'í‚¤ (cm)', 
                    data: heightData,
                    borderColor: 'rgb(75, 192, 192)', 
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    yAxisID: 'yHeight', 
                    spanGaps: true 
                },
                {
                    label: 'ëª¸ë¬´ê²Œ (kg)', 
                    data: weightData,
                    borderColor: 'rgb(255, 99, 132)', 
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'yWeight', 
                    spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                yHeight: { 
                    type: 'linear', 
                    display: true, 
                    position: 'left', 
                    title: { display: true, text: 'í‚¤(cm)' }
                },
                yWeight: { 
                    type: 'linear', 
                    display: true, 
                    position: 'right', 
                    title: { display: true, text: 'ëª¸ë¬´ê²Œ(kg)' }, 
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

function loadSchedules() {
    const schedules = BabyApi.getSchedules();
    const $list = $("#schedule-list");
    $list.empty();
    
    if (schedules.length === 0) {
        $list.append("<li>ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>");
    } else {
        schedules.forEach((schedule, index) => {
            const date = new Date(schedule.date);
            const localDateTime = date.toLocaleString('ko-KR', {
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long', 
                hour: '2-digit', 
                minute: '2-digit'
            });
            
            $list.append(`
                <li>
                    <a href="#" data-index="${index}" data-page="schedule-detail">
                        <h2>${schedule.title}</h2>
                        <p>${localDateTime}</p>
                        <p class="ui-li-aside"><strong>${schedule.alert === 'on' ? 'ì•Œë¦¼ ON' : 'ì•Œë¦¼ OFF'}</strong></p>
                    </a>
                </li>
            `);
        });
    }
    $list.listview("refresh");
}

function requestNotificationPermission(schedule) {
    if (!("Notification" in window)) { 
        console.log("ì´ ë¸Œë¼ìš°ì €ëŠ” ë°ìŠ¤í¬í†± ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); 
    }
    else if (Notification.permission === "granted") {
        new Notification(schedule.title, { body: `ì¼ì • ì•Œë¦¼: ${schedule.date}` });
    }
    else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
                new Notification(schedule.title, { body: `ì¼ì • ì•Œë¦¼: ${schedule.date}` });
            }
        });
    }
}

function loadAlbumDetail() {
    const index = $.data(document.body, "selectedIndex");
    if (index === undefined) { 
        $(":mobile-pagecontainer").pagecontainer("back"); 
        return; 
    }
    
    const records = BabyApi.getAlbumRecords();
    const record = records[index];
    
    if (!record) { 
        alert("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); 
        $(":mobile-pagecontainer").pagecontainer("back"); 
        return; 
    }
    
    const $content = $("#album-detail-content");
    const date = new Date(record.timestamp);
    const localDateTime = date.toLocaleString('ko-KR');
    
    const displaySrc = convertFileSrc(record.imageSrc);

    $content.html(`
        <img src="${displaySrc}" alt="ìƒì„¸ ì‚¬ì§„">
        <h3>[${record.type}]</h3>
        <p class="detail-memo">${record.memo || 'ë©”ëª¨ ì—†ìŒ'}</p>
        <hr>
        <p><small>ì €ì¥ ì‹œê°„: ${localDateTime}</small></p>
    `);
    
    $("#album-delete-btn").data("index", index);
}

function loadScheduleDetail() {
    const index = $.data(document.body, "selectedIndex");
    if (index === undefined) { 
        $(":mobile-pagecontainer").pagecontainer("back"); 
        return; 
    }
    
    const schedules = BabyApi.getSchedules();
    const schedule = schedules[index];
    
    if (!schedule) { 
        alert("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); 
        $(":mobile-pagecontainer").pagecontainer("back"); 
        return; 
    }
    
    const $content = $("#schedule-detail-content");
    const date = new Date(schedule.date);
    const localDateTime = date.toLocaleString('ko-KR', {
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        weekday: 'long', 
        hour: '2-digit', 
        minute: '2-digit'
    });
    
    const alertStatus = schedule.alert === 'on' ? 'ì•Œë¦¼ ON' : 'ì•Œë¦¼ OFF';
    
    $content.html(`
        <h2>${schedule.title}</h2>
        <p><strong>ì¼ì‹œ:</strong> ${localDateTime}</p>
        <p><strong>ì•Œë¦¼:</strong> ${alertStatus}</p>
    `);
    
    $("#schedule-delete-btn").data("index", index);
}

function loadRandomPhoto() {
    const records = BabyApi.getAlbumRecords();
    const $container = $("#random-photo-container");
    
    if (records.length === 0) {
        $container.html("<p>ì•„ì§ ì €ì¥ëœ ì‚¬ì§„ì´ ì—†ì–´ìš”. ì²« ì¶”ì–µì„ ê¸°ë¡í•´ë³´ì„¸ìš”!</p>");
    } else {
        const randomIndex = Math.floor(Math.random() * records.length);
        const record = records[randomIndex];
        const memo = record.memo ? `<p>${record.memo}</p>` : "<p>ì†Œì¤‘í•œ ìˆœê°„ âœ¨</p>";

        const displaySrc = convertFileSrc(record.imageSrc);

        $container.html(`
            <a href="#" class="random-photo-link" data-index="${randomIndex}" data-page="album-detail">
                <img src="${displaySrc}" alt="ëœë¤ ì¶”ì–µ ì‚¬ì§„">
                ${memo}
            </a>
        `);
    }
}
</script>

</body>
</html>
